const fs = require('fs');
const path = require('path');
const mime = require('mime-types');
const { execSync } = require('child_process');

// é€’å½’èŽ·å–æ–‡ä»¶åˆ—è¡¨
function getAllFiles(dirPath, arrayOfFiles = []) {
    const files = fs.readdirSync(dirPath);

    files.forEach(file => {
        const filePath = path.join(dirPath, file);
        if (fs.statSync(filePath).isDirectory()) {
            arrayOfFiles = getAllFiles(filePath, arrayOfFiles);
        } else {
            arrayOfFiles.push(path.relative(process.cwd(), filePath));
        }
    });

    return arrayOfFiles;
}

// æ–‡ä»¶è½¬æ¢é€»è¾‘
function convertFileToJS(filePath) {
    const mimeType = mime.lookup(filePath) || 'application/octet-stream';
    const isText = mimeType.startsWith('text/') ||
        mimeType === 'application/json' ||
        mimeType === 'application/javascript';

    try {
        let content;
        if (isText) {
            content = fs.readFileSync(filePath, 'utf8');
            return `'${content.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/\n/g, '\\n')}'`;
        } else {
            const buffer = fs.readFileSync(filePath);
            const base64 = buffer.toString('base64');
            return `'data:${mimeType};base64,${base64}'`;
        }
    } catch (err) {
        console.error(`âŒ è¯»å–æ–‡ä»¶é”™è¯¯ ${filePath}:`, err);
        return 'null';
    }
}

// ä¸»æž„å»ºå‡½æ•°
function build(options = {}) {
    const config = {
        inputDir: './src',
        outputFile: './build/index.js',
        generateId: true,
        generateManifest: true,
        ...options
    };

    // åˆ›å»ºè¾“å‡ºç›®å½•
    const buildDir = path.dirname(config.outputFile);
    if (!fs.existsSync(buildDir)) {
        fs.mkdirSync(buildDir, { recursive: true });
    }

    // ç”ŸæˆIDæ–‡ä»¶é€»è¾‘
    if (config.generateId) {
        const idFilePath = path.join(buildDir, 'id.npem');
        if (!fs.existsSync(idFilePath)) {
            try {
                console.log('ðŸ†” æ­£åœ¨ç”Ÿæˆå”¯ä¸€æ ‡è¯†...');
                execSync(`node "${path.join(__dirname, 'generate-id.js')}"`, {
                    stdio: 'inherit',
                    cwd: process.cwd()
                });
                console.log('ðŸ†” å”¯ä¸€æ ‡è¯†ç”ŸæˆæˆåŠŸ');
                console.log('â„¹ï¸ è¯·å¦¥å–„ä¿å­˜æ­¤å”¯ä¸€æ ‡è¯†ï¼Œä¸¢å¤±æ— æ³•å¤åŽŸ');
            } catch (err) {
                console.error('âŒ ç”ŸæˆIDæ–‡ä»¶å¤±è´¥:', err);
                process.exit(1);
            }
        }
    }

    // ç”Ÿæˆæ¸…å•æ–‡ä»¶é€»è¾‘
    if (config.generateManifest) {
        const manifestPath = path.join(buildDir, 'manifest.json');
        if (!fs.existsSync(manifestPath)) {
            try {
                const idFilePath = path.join(buildDir, 'id.npem');
                const id = fs.existsSync(idFilePath)
                    ? fs.readFileSync(idFilePath, 'utf8').trim()
                    : '';

                const manifest = {
                    name: "My Plugin",
                    version: "1.0.0",
                    updateUrl: "[åªéœ€å¡«å†™æ›´æ–°ç›®å½• // please fill in the update directory only.]",
                    id: id,
                    description: "[ä»‹ç» // description]",
                    picture: [
                        "[PicURL1]",
                        "[PicURL2]"
                    ]
                };
                fs.writeFileSync(manifestPath, JSON.stringify(manifest, null, 2));
                console.log('âœ… æ¸…å•æ–‡ä»¶å·²åˆ›å»º');
            } catch (err) {
                console.error('âŒ åˆ›å»ºæ¸…å•æ–‡ä»¶å¤±è´¥:', err);
                process.exit(1);
            }
        }
    }

    // ä¸»å¤„ç†é€»è¾‘
    if (!fs.existsSync(config.inputDir)) {
        throw new Error(`âŒ ç›®å½•ä¸å­˜åœ¨: ${config.inputDir}`);
    }

    const allFiles = getAllFiles(config.inputDir);

    // ç”ŸæˆJSè¾“å‡ºå†…å®¹
    const entries = allFiles.map(filePath => {
        const relativePath = path.relative(config.inputDir, filePath);
        const jsContent = convertFileToJS(filePath);
        return `  '${relativePath}': ${jsContent}`;
    }).join(',\n');

    const jsOutput = `// Generated by NitaiFarmePluginDev
const resources = {
${entries}
};

if (typeof module !== 'undefined' && module.exports) {
    module.exports = resources;
} else {
    window.resources = resources;
}`;

    fs.writeFileSync(config.outputFile, jsOutput);
    return { fileCount: allFiles.length };
}

module.exports = { build };